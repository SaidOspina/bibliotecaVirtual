<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Bibliotecaria</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #dee2e6;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            min-height: 500px;
        }

        .hidden {
            display: none !important;
        }

        .form-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-reserved {
            background: #fff3cd;
            color: #856404;
        }

        .status-borrowed {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .user-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">üìö Sistema Bibliotecario</div>
            <div class="nav-buttons" id="navButtons">
                <button class="btn btn-primary" onclick="showLogin()">Iniciar Sesi√≥n</button>
                <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
            </div>
        </header>

        <main class="main-content">
            <!-- Login Form -->
            <div id="loginForm" class="form-container">
                <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Iniciar Sesi√≥n</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label for="loginEmail">Correo Electr√≥nico</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Ingresar</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    ¬øNo tienes cuenta? <a href="#" onclick="showRegister()" style="color: #667eea;">Reg√≠strate aqu√≠</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="form-container hidden">
                <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Registro de Alumno</h2>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <label for="regName">Nombre Completo</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Correo Electr√≥nico</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Contrase√±a</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="regStudentId">N√∫mero de Estudiante</label>
                        <input type="text" id="regStudentId" required>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Tel√©fono</label>
                        <input type="tel" id="regPhone" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Registrarse</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    ¬øYa tienes cuenta? <a href="#" onclick="showLogin()" style="color: #667eea;">Inicia sesi√≥n aqu√≠</a>
                </p>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="hidden">
                <div class="user-info" id="userInfo"></div>
                
                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden">
                    <h2>Panel de Administraci√≥n</h2>
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">Gesti√≥n de Usuarios</div>
                            <button class="btn btn-primary" onclick="showUserManagement()">Ver Usuarios</button>
                            <button class="btn btn-secondary" onclick="showAddUser()">Agregar Usuario</button>
                        </div>
                        <div class="card">
                            <div class="card-title">Reportes del Sistema</div>
                            <button class="btn btn-primary" onclick="showReports()">Ver Reportes</button>
                        </div>
                    </div>
                </div>

                <!-- Librarian Dashboard -->
                <div id="librarianDashboard" class="hidden">
                    <h2>Panel de Bibliotecario</h2>
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">Gesti√≥n de Libros</div>
                            <button class="btn btn-primary" onclick="showBookManagement()">Ver Cat√°logo</button>
                            <button class="btn btn-secondary" onclick="showAddBook()">Agregar Libro</button>
                        </div>
                        <div class="card">
                            <div class="card-title">Pr√©stamos y Devoluciones</div>
                            <button class="btn btn-primary" onclick="showLoans()">Gestionar Pr√©stamos</button>
                            <button class="btn btn-secondary" onclick="showReturns()">Procesar Devoluciones</button>
                        </div>
                        <div class="card">
                            <div class="card-title">Multas y Da√±os</div>
                            <button class="btn btn-danger" onclick="showFines()">Ver Multas</button>
                            <button class="btn btn-secondary" onclick="showDamageReport()">Reportar Da√±os</button>
                        </div>
                    </div>
                </div>

                <!-- Reader Dashboard -->
                <div id="readerDashboard" class="hidden">
                    <h2>Mi Biblioteca</h2>
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">Cat√°logo de Libros</div>
                            <button class="btn btn-primary" onclick="showCatalog()">Explorar Cat√°logo</button>
                        </div>
                        <div class="card">
                            <div class="card-title">Mis Pr√©stamos</div>
                            <button class="btn btn-primary" onclick="showMyLoans()">Ver Pr√©stamos Actuales</button>
                            <button class="btn btn-secondary" onclick="showLoanHistory()">Historial</button>
                        </div>
                        <div class="card">
                            <div class="card-title">Mis Reservaciones</div>
                            <button class="btn btn-primary" onclick="showMyReservations()">Ver Reservaciones</button>
                        </div>
                        <div class="card" id="finesCard" class="hidden">
                            <div class="card-title">Mis Multas</div>
                            <button class="btn btn-danger" onclick="showMyFines()">Ver Multas Pendientes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div id="contentArea" class="hidden">
                <button class="btn btn-secondary" onclick="goBack()" style="margin-bottom: 20px;">‚Üê Volver</button>
                <div id="contentBody"></div>
            </div>
        </main>
    </div>

    <!-- Modal for various forms -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Sistema de datos simulado
        let currentUser = null;
        let users = [
            {
                id: 1,
                name: 'Admin Principal',
                email: 'admin@biblioteca.com',
                password: 'admin123',
                role: 'admin'
            },
            {
                id: 2,
                name: 'Juan Bibliotecario',
                email: 'bibliotecario@biblioteca.com',
                password: 'biblio123',
                role: 'librarian'
            },
            {
                id: 3,
                name: 'Mar√≠a Estudiante',
                email: 'maria@estudiante.com',
                password: 'est123',
                role: 'student',
                studentId: '2023001',
                phone: '123456789',
                activePrestamos: 0,
                maxPrestamos: 3,
                prestamoDays: 7,
                blocked: false,
                reservations: 0,
                maxReservations: 2
            },
            {
                id: 4,
                name: 'Dr. Carlos Profesor',
                email: 'carlos@profesor.com',
                password: 'prof123',
                role: 'teacher',
                employeeId: 'T001',
                activePrestamos: 0,
                maxPrestamos: 8,
                prestamoDays: 14,
                blocked: false,
                reservations: 0,
                maxReservations: 2
            }
        ];

        let books = [
            {
                id: 1,
                title: 'Cien a√±os de soledad',
                author: 'Gabriel Garc√≠a M√°rquez',
                isbn: '978-0-307-47472-4',
                category: 'Literatura',
                value: 45000,
                copies: [
                    {id: 1, status: 'available', condition: 'Excelente'},
                    {id: 2, status: 'borrowed', condition: 'Bueno', borrowedBy: 3, dueDate: '2025-06-03'},
                    {id: 3, status: 'reserved', condition: 'Excelente', reservedBy: 4, reservationDate: '2025-05-27'}
                ]
            },
            {
                id: 2,
                title: 'El Quijote',
                author: 'Miguel de Cervantes',
                isbn: '978-84-376-0494-7',
                category: 'Cl√°sicos',
                value: 35000,
                copies: [
                    {id: 4, status: 'available', condition: 'Bueno'},
                    {id: 5, status: 'available', condition: 'Excelente'}
                ]
            }
        ];

        let loans = [
            {
                id: 1,
                userId: 3,
                bookId: 1,
                copyId: 2,
                loanDate: '2025-05-20',
                dueDate: '2025-06-03',
                status: 'active'
            }
        ];

        let reservations = [
            {
                id: 1,
                userId: 4,
                bookId: 1,
                copyId: 3,
                reservationDate: '2025-05-27',
                expirationDate: '2025-05-28',
                status: 'active'
            }
        ];

        let fines = [];

        // Funciones de navegaci√≥n
        function showLogin() {
            hideAll();
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showRegister() {
            hideAll();
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('contentArea').classList.add('hidden');
        }

        function goBack() {
            document.getElementById('contentArea').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showContent(title, content) {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('contentArea').classList.remove('hidden');
            document.getElementById('contentBody').innerHTML = `<h2>${title}</h2>${content}`;
        }

        // Autenticaci√≥n
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                showDashboard();
            } else {
                alert('Credenciales incorrectas');
            }
        }

        function register(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const studentId = document.getElementById('regStudentId').value;
            const phone = document.getElementById('regPhone').value;

            // Verificar si el email ya existe
            if (users.find(u => u.email === email)) {
                alert('Este correo ya est√° registrado');
                return;
            }

            const newUser = {
                id: users.length + 1,
                name,
                email,
                password,
                role: 'student',
                studentId,
                phone,
                activePrestamos: 0,
                maxPrestamos: 3,
                prestamoDays: 7,
                blocked: false,
                reservations: 0,
                maxReservations: 2
            };

            users.push(newUser);
            alert('Registro exitoso. Ahora puedes iniciar sesi√≥n.');
            showLogin();
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Actualizar informaci√≥n del usuario
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <h3>Bienvenido, ${currentUser.name}</h3>
                <p>Rol: ${getRoleName(currentUser.role)}</p>
                ${currentUser.role === 'student' || currentUser.role === 'teacher' ? 
                    `<p>Pr√©stamos activos: ${currentUser.activePrestamos}/${currentUser.maxPrestamos}</p>
                     <p>Reservaciones: ${currentUser.reservations}/${currentUser.maxReservations}</p>
                     ${currentUser.blocked ? '<p style="color: #ff6b6b;">‚ö†Ô∏è Cuenta bloqueada - Devuelve los libros pendientes</p>' : ''}` : ''
                }
            `;

            // Actualizar botones de navegaci√≥n
            document.getElementById('navButtons').innerHTML = `
                <span style="color: #667eea; font-weight: 500;">${currentUser.name}</span>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
            `;

            // Mostrar dashboard espec√≠fico seg√∫n el rol
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('librarianDashboard').classList.add('hidden');
            document.getElementById('readerDashboard').classList.add('hidden');

            if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
            } else if (currentUser.role === 'librarian') {
                document.getElementById('librarianDashboard').classList.remove('hidden');
            } else {
                document.getElementById('readerDashboard').classList.remove('hidden');
                // Mostrar card de multas solo si hay multas pendientes
                const userFines = fines.filter(f => f.userId === currentUser.id && f.status === 'pending');
                if (userFines.length > 0) {
                    document.getElementById('finesCard').classList.remove('hidden');
                }
            }
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'Administrador',
                'librarian': 'Bibliotecario',
                'student': 'Alumno',
                'teacher': 'Docente'
            };
            return roles[role] || role;
        }

        function logout() {
            currentUser = null;
            document.getElementById('navButtons').innerHTML = `
                <button class="btn btn-primary" onclick="showLogin()">Iniciar Sesi√≥n</button>
                <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
            `;
            showLogin();
        }

        // Funciones de gesti√≥n de libros
        function showCatalog() {
            let content = `
                <div class="form-group">
                    <input type="text" placeholder="Buscar libros..." onkeyup="filterBooks(this.value)">
                </div>
                <table class="table" id="catalogTable">
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Autor</th>
                            <th>Categor√≠a</th>
                            <th>Disponibles</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            books.forEach(book => {
                const availableCopies = book.copies.filter(c => c.status === 'available').length;
                const reservedCopies = book.copies.filter(c => c.status === 'reserved').length;
                
                content += `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.category}</td>
                        <td>
                            <span class="status-badge status-available">${availableCopies} disponibles</span>
                            ${reservedCopies > 0 ? `<span class="status-badge status-reserved">${reservedCopies} reservados</span>` : ''}
                        </td>
                        <td>
                            ${availableCopies > 0 && currentUser.reservations < currentUser.maxReservations && !currentUser.blocked ? 
                                `<button class="btn btn-primary" onclick="reserveBook(${book.id})">Reservar</button>` : 
                                '<span style="color: #6c757d;">No disponible</span>'
                            }
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Cat√°logo de Libros', content);
        }

        function reserveBook(bookId) {
            if (currentUser.blocked) {
                alert('Tu cuenta est√° bloqueada. No puedes hacer reservaciones.');
                return;
            }

            if (currentUser.reservations >= currentUser.maxReservations) {
                alert(`Ya tienes el m√°ximo de ${currentUser.maxReservations} reservaciones permitidas.`);
                return;
            }

            const book = books.find(b => b.id === bookId);
            const availableCopy = book.copies.find(c => c.status === 'available');

            if (!availableCopy) {
                alert('No hay ejemplares disponibles para reservar.');
                return;
            }

            // Crear reservaci√≥n
            const newReservation = {
                id: reservations.length + 1,
                userId: currentUser.id,
                bookId: bookId,
                copyId: availableCopy.id,
                reservationDate: new Date().toISOString().split('T')[0],
                expirationDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                status: 'active'
            };

            reservations.push(newReservation);
            availableCopy.status = 'reserved';
            availableCopy.reservedBy = currentUser.id;
            availableCopy.reservationDate = newReservation.reservationDate;
            
            currentUser.reservations++;

            alert(`Libro "${book.title}" reservado exitosamente. Tienes 24 horas para retirarlo.`);
            showDashboard();
        }

        function showMyReservations() {
            const userReservations = reservations.filter(r => r.userId === currentUser.id && r.status === 'active');
            
            let content = '<h3>Mis Reservaciones Activas</h3>';
            
            if (userReservations.length === 0) {
                content += '<p>No tienes reservaciones activas.</p>';
            } else {
                content += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Fecha de Reservaci√≥n</th>
                                <th>Expira</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userReservations.forEach(reservation => {
                    const book = books.find(b => b.id === reservation.bookId);
                    const isExpired = new Date(reservation.expirationDate) < new Date();
                    
                    content += `
                        <tr>
                            <td>${book.title}</td>
                            <td>${reservation.reservationDate}</td>
                            <td>${reservation.expirationDate}</td>
                            <td>
                                <span class="status-badge ${isExpired ? 'status-borrowed' : 'status-reserved'}">
                                    ${isExpired ? 'Expirada' : 'Activa'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-danger" onclick="cancelReservation(${reservation.id})">Cancelar</button>
                            </td>
                        </tr>
                    `;
                });

                content += '</tbody></table>';
            }

            showContent('Mis Reservaciones', content);
        }

        function cancelReservation(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (reservation) {
                reservation.status = 'cancelled';
                
                // Liberar el ejemplar
                const book = books.find(b => b.id === reservation.bookId);
                const copy = book.copies.find(c => c.id === reservation.copyId);
                copy.status = 'available';
                delete copy.reservedBy;
                delete copy.reservationDate;
                
                currentUser.reservations--;
                
                alert('Reservaci√≥n cancelada exitosamente.');
                showMyReservations();
            }
        }

        function showMyLoans() {
            const userLoans = loans.filter(l => l.userId === currentUser.id && l.status === 'active');
            
            let content = '<h3>Mis Pr√©stamos Actuales</h3>';
            
            if (userLoans.length === 0) {
                content += '<p>No tienes pr√©stamos activos.</p>';
            } else {
                content += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Fecha de Pr√©stamo</th>
                                <th>Fecha de Vencimiento</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userLoans.forEach(loan => {
                    const book = books.find(b => b.id === loan.bookId);
                    const isOverdue = new Date(loan.dueDate) < new Date();
                    
                    content += `
                        <tr>
                            <td>${book.title}</td>
                            <td>${loan.loanDate}</td>
                            <td>${loan.dueDate}</td>
                            <td>
                                <span class="status-badge ${isOverdue ? 'status-borrowed' : 'status-available'}">
                                    ${isOverdue ? 'Vencido' : 'Activo'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                content += '</tbody></table>';
            }

            showContent('Mis Pr√©stamos', content);
        }

        function showLoanHistory() {
            const userLoans = loans.filter(l => l.userId === currentUser.id);
            
            let content = '<h3>Historial de Pr√©stamos</h3>';
            
            if (userLoans.length === 0) {
                content += '<p>No tienes historial de pr√©stamos.</p>';
            } else {
                content += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Fecha de Pr√©stamo</th>
                                <th>Fecha de Vencimiento</th>
                                <th>Fecha de Devoluci√≥n</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userLoans.forEach(loan => {
                    const book = books.find(b => b.id === loan.bookId);
                    
                    content += `
                        <tr>
                            <td>${book.title}</td>
                            <td>${loan.loanDate}</td>
                            <td>${loan.dueDate}</td>
                            <td>${loan.returnDate || 'Pendiente'}</td>
                            <td>
                                <span class="status-badge ${loan.status === 'returned' ? 'status-available' : 'status-borrowed'}">
                                    ${loan.status === 'returned' ? 'Devuelto' : 'Activo'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                content += '</tbody></table>';
            }

            showContent('Historial de Pr√©stamos', content);
        }

        function showMyFines() {
            const userFines = fines.filter(f => f.userId === currentUser.id);
            
            let content = '<h3>Mis Multas</h3>';
            
            if (userFines.length === 0) {
                content += '<p>No tienes multas pendientes.</p>';
            } else {
                content += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userFines.forEach(fine => {
                    content += `
                        <tr>
                            <td>${fine.type === 'late' ? 'Retraso' : 'Da√±o'}</td>
                            <td>${fine.description}</td>
                            <td>${fine.amount.toLocaleString()} COP</td>
                            <td>${fine.date}</td>
                            <td>
                                <span class="status-badge ${fine.status === 'paid' ? 'status-available' : 'status-borrowed'}">
                                    ${fine.status === 'paid' ? 'Pagada' : 'Pendiente'}
                                </span>
                            </td>
                            <td>
                                ${fine.status === 'pending' ? `<button class="btn btn-primary" onclick="printFine(${fine.id})">Imprimir</button>` : ''}
                            </td>
                        </tr>
                    `;
                });

                content += '</tbody></table>';
            }

            showContent('Mis Multas', content);
        }

        function printFine(fineId) {
            const fine = fines.find(f => f.id === fineId);
            const user = users.find(u => u.id === fine.userId);
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <h2 style="text-align: center; color: #667eea;">Sistema Bibliotecario</h2>
                    <h3 style="text-align: center;">COMPROBANTE DE MULTA</h3>
                    <hr>
                    <p><strong>Usuario:</strong> ${user.name}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Fecha:</strong> ${fine.date}</p>
                    <p><strong>Tipo de Multa:</strong> ${fine.type === 'late' ? 'Retraso en devoluci√≥n' : 'Da√±o al material'}</p>
                    <p><strong>Descripci√≥n:</strong> ${fine.description}</p>
                    <p><strong>Monto:</strong> ${fine.amount.toLocaleString()} COP</p>
                    <hr>
                    <p style="text-align: center; margin-top: 30px;">
                        <small>Este documento es v√°lido para el pago de la multa</small>
                    </p>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Funciones del Bibliotecario
        function showBookManagement() {
            let content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0; flex: 1; margin-right: 20px;">
                        <input type="text" placeholder="Buscar libros..." onkeyup="filterBooksLibrarian(this.value)">
                    </div>
                    <button class="btn btn-primary" onclick="showAddBook()">Agregar Libro</button>
                </div>
                <table class="table" id="librarianBooksTable">
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Autor</th>
                            <th>ISBN</th>
                            <th>Ejemplares</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            books.forEach(book => {
                const totalCopies = book.copies.length;
                const availableCopies = book.copies.filter(c => c.status === 'available').length;
                const borrowedCopies = book.copies.filter(c => c.status === 'borrowed').length;
                const reservedCopies = book.copies.filter(c => c.status === 'reserved').length;
                
                content += `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.isbn}</td>
                        <td>${totalCopies}</td>
                        <td>
                            <span class="status-badge status-available">${availableCopies} disp.</span>
                            <span class="status-badge status-borrowed">${borrowedCopies} prest.</span>
                            <span class="status-badge status-reserved">${reservedCopies} res.</span>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="showBookDetails(${book.id})">Ver</button>
                            <button class="btn btn-primary" onclick="addCopy(${book.id})">+ Ejemplar</button>
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Gesti√≥n de Libros', content);
        }

        function showAddBook() {
            const modalContent = `
                <h3>Agregar Nuevo Libro</h3>
                <form onsubmit="addBook(event)">
                    <div class="form-group">
                        <label>T√≠tulo</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Autor</label>
                        <input type="text" id="bookAuthor" required>
                    </div>
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" id="bookISBN" required>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <input type="text" id="bookCategory" required>
                    </div>
                    <div class="form-group">
                        <label>Valor del libro (COP)</label>
                        <input type="number" id="bookValue" required>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de ejemplares</label>
                        <input type="number" id="bookCopies" min="1" value="1" required>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function addBook(event) {
            event.preventDefault();
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const isbn = document.getElementById('bookISBN').value;
            const category = document.getElementById('bookCategory').value;
            const value = parseInt(document.getElementById('bookValue').value);
            const copiesCount = parseInt(document.getElementById('bookCopies').value);

            const newBook = {
                id: books.length + 1,
                title,
                author,
                isbn,
                category,
                value,
                copies: []
            };

            // Crear los ejemplares
            for (let i = 0; i < copiesCount; i++) {
                newBook.copies.push({
                    id: Date.now() + i,
                    status: 'available',
                    condition: 'Excelente'
                });
            }

            books.push(newBook);
            closeModal();
            alert('Libro agregado exitosamente');
            showBookManagement();
        }

        function showLoans() {
            let content = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showNewLoan()">Nuevo Pr√©stamo</button>
                </div>
                <h3>Pr√©stamos Activos</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Libro</th>
                            <th>Fecha Pr√©stamo</th>
                            <th>Fecha Vencimiento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const activeLoans = loans.filter(l => l.status === 'active');
            activeLoans.forEach(loan => {
                const user = users.find(u => u.id === loan.userId);
                const book = books.find(b => b.id === loan.bookId);
                const isOverdue = new Date(loan.dueDate) < new Date();
                
                content += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${book.title}</td>
                        <td>${loan.loanDate}</td>
                        <td>${loan.dueDate}</td>
                        <td>
                            <span class="status-badge ${isOverdue ? 'status-borrowed' : 'status-available'}">
                                ${isOverdue ? 'Vencido' : 'Activo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="processReturn(${loan.id})">Procesar Devoluci√≥n</button>
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Gesti√≥n de Pr√©stamos', content);
        }

        function showNewLoan() {
            const modalContent = `
                <h3>Nuevo Pr√©stamo</h3>
                <form onsubmit="createLoan(event)">
                    <div class="form-group">
                        <label>Usuario</label>
                        <select id="loanUserId" required>
                            <option value="">Seleccionar usuario...</option>
                            ${users.filter(u => u.role === 'student' || u.role === 'teacher').map(u => 
                                `<option value="${u.id}">${u.name} (${getRoleName(u.role)})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Libro</label>
                        <select id="loanBookId" required onchange="updateAvailableCopies()">
                            <option value="">Seleccionar libro...</option>
                            ${books.filter(b => b.copies.some(c => c.status === 'available')).map(b => 
                                `<option value="${b.id}">${b.title}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ejemplar</label>
                        <select id="loanCopyId" required>
                            <option value="">Primero selecciona un libro</option>
                        </select>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Pr√©stamo</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function updateAvailableCopies() {
            const bookId = document.getElementById('loanBookId').value;
            const copySelect = document.getElementById('loanCopyId');
            
            if (!bookId) {
                copySelect.innerHTML = '<option value="">Primero selecciona un libro</option>';
                return;
            }

            const book = books.find(b => b.id == bookId);
            const availableCopies = book.copies.filter(c => c.status === 'available');
            
            copySelect.innerHTML = availableCopies.map(c => 
                `<option value="${c.id}">Ejemplar ${c.id} (${c.condition})</option>`
            ).join('');
        }

        function createLoan(event) {
            event.preventDefault();
            const userId = parseInt(document.getElementById('loanUserId').value);
            const bookId = parseInt(document.getElementById('loanBookId').value);
            const copyId = parseInt(document.getElementById('loanCopyId').value);

            const user = users.find(u => u.id === userId);
            
            // Verificar si el usuario est√° bloqueado
            if (user.blocked) {
                alert('Este usuario est√° bloqueado y no puede recibir pr√©stamos.');
                return;
            }

            // Verificar l√≠mite de pr√©stamos
            if (user.activePrestamos >= user.maxPrestamos) {
                alert(`Este usuario ya tiene el m√°ximo de ${user.maxPrestamos} pr√©stamos permitidos.`);
                return;
            }

            const book = books.find(b => b.id === bookId);
            const copy = book.copies.find(c => c.id === copyId);

            // Calcular fecha de vencimiento
            const loanDate = new Date();
            const dueDate = new Date(loanDate);
            dueDate.setDate(dueDate.getDate() + user.prestamoDays);

            // Crear pr√©stamo
            const newLoan = {
                id: loans.length + 1,
                userId,
                bookId,
                copyId,
                loanDate: loanDate.toISOString().split('T')[0],
                dueDate: dueDate.toISOString().split('T')[0],
                status: 'active'
            };

            loans.push(newLoan);
            copy.status = 'borrowed';
            copy.borrowedBy = userId;
            copy.dueDate = newLoan.dueDate;
            user.activePrestamos++;

            closeModal();
            alert('Pr√©stamo creado exitosamente');
            showLoans();
        }

        function processReturn(loanId) {
            const loan = loans.find(l => l.id === loanId);
            const user = users.find(u => u.id === loan.userId);
            const book = books.find(b => b.id === loan.bookId);
            const copy = book.copies.find(c => c.id === loan.copyId);

            const modalContent = `
                <h3>Procesar Devoluci√≥n</h3>
                <div class="alert alert-info">
                    <strong>Usuario:</strong> ${user.name}<br>
                    <strong>Libro:</strong> ${book.title}<br>
                    <strong>Fecha de vencimiento:</strong> ${loan.dueDate}
                </div>
                <form onsubmit="completeReturn(event, ${loanId})">
                    <div class="form-group">
                        <label>Estado del ejemplar</label>
                        <select id="returnCondition" onchange="checkCondition()" required>
                            <option value="same">Mismo estado (${copy.condition})</option>
                            <option value="damaged">Con da√±os</option>
                        </select>
                    </div>
                    <div id="damageSection" class="hidden">
                        <div class="form-group">
                            <label>Descripci√≥n del da√±o</label>
                            <textarea id="damageDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>¬øEl libro debe ser retirado?</label>
                            <select id="shouldRetire">
                                <option value="no">No</option>
                                <option value="yes">S√≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto de la multa (m√°ximo ${book.value.toLocaleString()} COP)</label>
                            <input type="number" id="damageFinAmount" max="${book.value}" min="0" value="0">
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Procesar Devoluci√≥n</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function checkCondition() {
            const condition = document.getElementById('returnCondition').value;
            const damageSection = document.getElementById('damageSection');
            
            if (condition === 'damaged') {
                damageSection.classList.remove('hidden');
            } else {
                damageSection.classList.add('hidden');
            }
        }

        function completeReturn(event, loanId) {
            event.preventDefault();
            const loan = loans.find(l => l.id === loanId);
            const user = users.find(u => u.id === loan.userId);
            const book = books.find(b => b.id === loan.bookId);
            const copy = book.copies.find(c => c.id === loan.copyId);

            const returnDate = new Date();
            const dueDate = new Date(loan.dueDate);
            const condition = document.getElementById('returnCondition').value;

            // Procesar devoluci√≥n
            loan.status = 'returned';
            loan.returnDate = returnDate.toISOString().split('T')[0];
            copy.status = 'available';
            delete copy.borrowedBy;
            delete copy.dueDate;
            user.activePrestamos--;

            // Verificar retraso (solo para estudiantes)
            if (returnDate > dueDate && user.role === 'student') {
                const daysLate = Math.ceil((returnDate - dueDate) / (1000 * 60 * 60 * 24));
                const fineAmount = daysLate * 500;

                const lateFine = {
                    id: fines.length + 1,
                    userId: user.id,
                    type: 'late',
                    description: `Retraso de ${daysLate} d√≠as en la devoluci√≥n de "${book.title}"`,
                    amount: fineAmount,
                    date: returnDate.toISOString().split('T')[0],
                    status: 'pending'
                };

                fines.push(lateFine);
            }

            // Desbloquear usuario si estaba bloqueado
            if (user.blocked && user.activePrestamos === 0) {
                user.blocked = false;
            }

            // Procesar da√±os si los hay
            if (condition === 'damaged') {
                const damageDescription = document.getElementById('damageDescription').value;
                const shouldRetire = document.getElementById('shouldRetire').value;
                const damageFinAmount = parseInt(document.getElementById('damageFinAmount').value) || 0;

                if (damageFinAmount > 0) {
                    const damageFine = {
                        id: fines.length + 1,
                        userId: user.id,
                        type: 'damage',
                        description: `Da√±o al libro "${book.title}": ${damageDescription}`,
                        amount: damageFinAmount,
                        date: returnDate.toISOString().split('T')[0],
                        status: 'pending'
                    };

                    fines.push(damageFine);
                }

                // Actualizar condici√≥n del ejemplar
                copy.condition = 'Da√±ado: ' + damageDescription;

                // Si debe ser retirado, simular notificaci√≥n a administradores
                if (shouldRetire === 'yes') {
                    copy.status = 'retired';
                    alert(`Libro marcado para retiro. Se ha enviado notificaci√≥n a los administradores:\n\nLibro: ${book.title}\nEjemplar: ${copy.id}\nDa√±o: ${damageDescription}`);
                }
            }

            closeModal();
            alert('Devoluci√≥n procesada exitosamente');
            showLoans();
        }

        // Funciones del Administrador
        function showUserManagement() {
            let content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Gesti√≥n de Usuarios</h3>
                    <button class="btn btn-primary" onclick="showAddUser()">Agregar Usuario</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Pr√©stamos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                if (user.id === currentUser.id) return; // No mostrar el usuario actual
                
                content += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${getRoleName(user.role)}</td>
                        <td>
                            ${user.blocked ? 
                                '<span class="status-badge status-borrowed">Bloqueado</span>' : 
                                '<span class="status-badge status-available">Activo</span>'
                            }
                        </td>
                        <td>
                            ${user.activePrestamos !== undefined ? 
                                `${user.activePrestamos}/${user.maxPrestamos}` : 'N/A'
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editUser(${user.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Gesti√≥n de Usuarios', content);
        }

        function showAddUser() {
            const modalContent = `
                <h3>Agregar Usuario</h3>
                <form onsubmit="addUser(event)">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="userPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="userRole" required onchange="updateUserFields()">
                            <option value="">Seleccionar rol...</option>
                            <option value="librarian">Bibliotecario</option>
                            <option value="teacher">Docente</option>
                            <option value="student">Alumno</option>
                        </select>
                    </div>
                    <div id="additionalFields"></div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function updateUserFields() {
            const role = document.getElementById('userRole').value;
            const additionalFields = document.getElementById('additionalFields');
            
            let fields = '';
            if (role === 'student') {
                fields = `
                    <div class="form-group">
                        <label>N√∫mero de Estudiante</label>
                        <input type="text" id="studentId" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="phone" required>
                    </div>
                `;
            } else if (role === 'teacher') {
                fields = `
                    <div class="form-group">
                        <label>ID de Empleado</label>
                        <input type="text" id="employeeId" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="phone" required>
                    </div>
                `;
            }
            
            additionalFields.innerHTML = fields;
        }

        function addUser(event) {
            event.preventDefault();
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            // Verificar si el email ya existe
            if (users.find(u => u.email === email)) {
                alert('Este correo ya est√° registrado');
                return;
            }

            const newUser = {
                id: users.length + 1,
                name,
                email,
                password,
                role
            };

            if (role === 'student') {
                newUser.studentId = document.getElementById('studentId').value;
                newUser.phone = document.getElementById('phone').value;
                newUser.activePrestamos = 0;
                newUser.maxPrestamos = 3;
                newUser.prestamoDays = 7;
                newUser.blocked = false;
                newUser.reservations = 0;
                newUser.maxReservations = 2;
            } else if (role === 'teacher') {
                newUser.employeeId = document.getElementById('employeeId').value;
                newUser.phone = document.getElementById('phone').value;
                newUser.activePrestamos = 0;
                newUser.maxPrestamos = 8;
                newUser.prestamoDays = 14;
                newUser.blocked = false;
                newUser.reservations = 0;
                newUser.maxReservations = 2;
            }

            users.push(newUser);
            closeModal();
            alert('Usuario agregado exitosamente');
            showUserManagement();
        }

        // Funciones auxiliares
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function filterBooks(query) {
            const table = document.getElementById('catalogTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                if (text.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            showLogin();
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Simular vencimiento de reservaciones
            setInterval(checkExpiredReservations, 60000); // Verificar cada minuto
        });

        function checkExpiredReservations() {
            const now = new Date();
            reservations.forEach(reservation => {
                if (reservation.status === 'active' && new Date(reservation.expirationDate) < now) {
                    reservation.status = 'expired';
                    
                    // Liberar el ejemplar
                    const book = books.find(b => b.id === reservation.bookId);
                    const copy = book.copies.find(c => c.id === reservation.copyId);
                    copy.status = 'available';
                    delete copy.reservedBy;
                    delete copy.reservationDate;
                    
                    // Actualizar contador de reservaciones del usuario
                    const user = users.find(u => u.id === reservation.userId);
                    if (user) {
                        user.reservations--;
                    }
                }
            });
        }

        // Funciones adicionales para completar el sistema
        function showBookDetails(bookId) {
            const book = books.find(b => b.id === bookId);
            
            let content = `
                <h3>${book.title}</h3>
                <div class="card">
                    <p><strong>Autor:</strong> ${book.author}</p>
                    <p><strong>ISBN:</strong> ${book.isbn}</p>
                    <p><strong>Categor√≠a:</strong> ${book.category}</p>
                    <p><strong>Valor:</strong> ${book.value.toLocaleString()} COP</p>
                </div>
                
                <h4 style="margin-top: 30px;">Ejemplares</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID Ejemplar</th>
                            <th>Estado</th>
                            <th>Condici√≥n</th>
                            <th>Informaci√≥n Adicional</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            book.copies.forEach(copy => {
                let additionalInfo = '';
                if (copy.status === 'borrowed') {
                    const user = users.find(u => u.id === copy.borrowedBy);
                    additionalInfo = `Prestado a: ${user.name}<br>Vence: ${copy.dueDate}`;
                } else if (copy.status === 'reserved') {
                    const user = users.find(u => u.id === copy.reservedBy);
                    additionalInfo = `Reservado por: ${user.name}<br>Desde: ${copy.reservationDate}`;
                }

                content += `
                    <tr>
                        <td>${copy.id}</td>
                        <td>
                            <span class="status-badge status-${copy.status === 'available' ? 'available' : copy.status === 'reserved' ? 'reserved' : 'borrowed'}">
                                ${copy.status === 'available' ? 'Disponible' : copy.status === 'reserved' ? 'Reservado' : copy.status === 'retired' ? 'Retirado' : 'Prestado'}
                            </span>
                        </td>
                        <td>${copy.condition}</td>
                        <td>${additionalInfo}</td>
                        <td>
                            ${copy.status === 'available' ? 
                                `<button class="btn btn-secondary" onclick="editCopy(${book.id}, ${copy.id})">Editar</button>` : ''
                            }
                            ${copy.status === 'retired' ? 
                                `<button class="btn btn-danger" onclick="removeCopy(${book.id}, ${copy.id})">Eliminar</button>` : ''
                            }
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent(`Detalles: ${book.title}`, content);
        }

        function addCopy(bookId) {
            const book = books.find(b => b.id === bookId);
            const newCopy = {
                id: Date.now(),
                status: 'available',
                condition: 'Excelente'
            };

            book.copies.push(newCopy);
            alert('Nuevo ejemplar agregado exitosamente');
            showBookDetails(bookId);
        }

        function showReports() {
            const totalBooks = books.length;
            const totalCopies = books.reduce((sum, book) => sum + book.copies.length, 0);
            const totalUsers = users.filter(u => u.role === 'student' || u.role === 'teacher').length;
            const activeLoans = loans.filter(l => l.status === 'active').length;
            const overdueLoans = loans.filter(l => l.status === 'active' && new Date(l.dueDate) < new Date()).length;
            const totalFines = fines.filter(f => f.status === 'pending').reduce((sum, f) => sum + f.amount, 0);

            const content = `
                <h3>Reportes del Sistema</h3>
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">Estad√≠sticas Generales</div>
                        <p><strong>Total de libros:</strong> ${totalBooks}</p>
                        <p><strong>Total de ejemplares:</strong> ${totalCopies}</p>
                        <p><strong>Usuarios registrados:</strong> ${totalUsers}</p>
                    </div>
                    <div class="card">
                        <div class="card-title">Pr√©stamos</div>
                        <p><strong>Pr√©stamos activos:</strong> ${activeLoans}</p>
                        <p><strong>Pr√©stamos vencidos:</strong> ${overdueLoans}</p>
                    </div>
                    <div class="card">
                        <div class="card-title">Multas</div>
                        <p><strong>Multas pendientes:</strong> ${fines.filter(f => f.status === 'pending').length}</p>
                        <p><strong>Monto total:</strong> ${totalFines.toLocaleString()} COP</p>
                    </div>
                    <div class="card">
                        <div class="card-title">Usuarios Bloqueados</div>
                        <p><strong>Cuentas bloqueadas:</strong> ${users.filter(u => u.blocked).length}</p>
                    </div>
                </div>

                <h4 style="margin-top: 30px;">Usuarios con Pr√©stamos Vencidos</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Libro</th>
                            <th>D√≠as de Retraso</th>
                            <th>Multa Generada</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const overdueDetails = loans.filter(l => l.status === 'active' && new Date(l.dueDate) < new Date());
            overdueDetails.forEach(loan => {
                const user = users.find(u => u.id === loan.userId);
                const book = books.find(b => b.id === loan.bookId);
                const daysLate = Math.ceil((new Date() - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
                const potentialFine = user.role === 'student' ? daysLate * 500 : 0;

                content += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${book.title}</td>
                        <td>${daysLate}</td>
                        <td>${potentialFine.toLocaleString()} COP</td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Reportes del Sistema', content);
        }

        function showFines() {
            let content = `
                <h3>Gesti√≥n de Multas</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            fines.forEach(fine => {
                const user = users.find(u => u.id === fine.userId);
                
                content += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${fine.type === 'late' ? 'Retraso' : 'Da√±o'}</td>
                        <td>${fine.description}</td>
                        <td>${fine.amount.toLocaleString()} COP</td>
                        <td>${fine.date}</td>
                        <td>
                            <span class="status-badge ${fine.status === 'paid' ? 'status-available' : 'status-borrowed'}">
                                ${fine.status === 'paid' ? 'Pagada' : 'Pendiente'}
                            </span>
                        </td>
                        <td>
                            ${fine.status === 'pending' ? 
                                `<button class="btn btn-success" onclick="markFinePaid(${fine.id})">Marcar como Pagada</button>` : 
                                '<span style="color: #6c757d;">Completada</span>'
                            }
                        </td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            showContent('Gesti√≥n de Multas', content);
        }

        function markFinePaid(fineId) {
            const fine = fines.find(f => f.id === fineId);
            if (fine) {
                fine.status = 'paid';
                fine.paidDate = new Date().toISOString().split('T')[0];
                alert('Multa marcada como pagada');
                showFines();
            }
        }

        function showDamageReport() {
            const modalContent = `
                <h3>Reportar Da√±o a Ejemplar</h3>
                <form onsubmit="createDamageReport(event)">
                    <div class="form-group">
                        <label>Libro</label>
                        <select id="damageBookId" required onchange="updateCopiesForDamage()">
                            <option value="">Seleccionar libro...</option>
                            ${books.map(b => 
                                `<option value="${b.id}">${b.title}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ejemplar</label>
                        <select id="damageCopyId" required>
                            <option value="">Primero selecciona un libro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n del da√±o</label>
                        <textarea id="damageReportDescription" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>¬øEl ejemplar debe ser retirado?</label>
                        <select id="shouldRetireBook" required>
                            <option value="no">No, puede seguir circulando</option>
                            <option value="yes">S√≠, debe ser retirado</option>
                        </select>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Reportar Da√±o</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function updateCopiesForDamage() {
            const bookId = document.getElementById('damageBookId').value;
            const copySelect = document.getElementById('damageCopyId');
            
            if (!bookId) {
                copySelect.innerHTML = '<option value="">Primero selecciona un libro</option>';
                return;
            }

            const book = books.find(b => b.id == bookId);
            
            copySelect.innerHTML = book.copies.map(c => 
                `<option value="${c.id}">Ejemplar ${c.id} (${c.condition}) - ${c.status === 'available' ? 'Disponible' : c.status === 'borrowed' ? 'Prestado' : 'Reservado'}</option>`
            ).join('');
        }

        function createDamageReport(event) {
            event.preventDefault();
            const bookId = parseInt(document.getElementById('damageBookId').value);
            const copyId = parseInt(document.getElementById('damageCopyId').value);
            const description = document.getElementById('damageReportDescription').value;
            const shouldRetire = document.getElementById('shouldRetireBook').value;

            const book = books.find(b => b.id === bookId);
            const copy = book.copies.find(c => c.id === copyId);

            // Actualizar el estado del ejemplar
            copy.condition = 'Da√±ado: ' + description;

            if (shouldRetire === 'yes') {
                copy.status = 'retired';
                
                // Simular env√≠o de email a administradores
                const emailContent = `
                    NOTIFICACI√ìN: Libro retirado del sistema
                    
                    Libro: ${book.title}
                    Autor: ${book.author}
                    ISBN: ${book.isbn}
                    Ejemplar ID: ${copy.id}
                    Motivo: ${description}
                    Fecha: ${new Date().toLocaleDateString()}
                    Reportado por: ${currentUser.name}
                `;
                
                alert('Ejemplar marcado para retiro.\n\nNotificaci√≥n enviada a administradores:\n\n' + emailContent);
            }

            closeModal();
            alert('Reporte de da√±o registrado exitosamente');
            showBookManagement();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            
            const modalContent = `
                <h3>Editar Usuario</h3>
                <form onsubmit="updateUser(event, ${userId})">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="editUserName" value="${user.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editUserEmail" value="${user.email}" required>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="editUserBlocked">
                            <option value="false" ${!user.blocked ? 'selected' : ''}>Activo</option>
                            <option value="true" ${user.blocked ? 'selected' : ''}>Bloqueado</option>
                        </select>
                    </div>
                    ${user.role === 'student' || user.role === 'teacher' ? `
                        <div class="form-group">
                            <label>L√≠mite de pr√©stamos</label>
                            <input type="number" id="editUserMaxPrestamos" value="${user.maxPrestamos}" min="1" max="10">
                        </div>
                    ` : ''}
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </div>
                </form>
            `;
            showModal(modalContent);
        }

        function updateUser(event, userId) {
            event.preventDefault();
            const user = users.find(u => u.id === userId);
            
            user.name = document.getElementById('editUserName').value;
            user.email = document.getElementById('editUserEmail').value;
            user.blocked = document.getElementById('editUserBlocked').value === 'true';
            
            if (user.role === 'student' || user.role === 'teacher') {
                user.maxPrestamos = parseInt(document.getElementById('editUserMaxPrestamos').value);
            }

            closeModal();
            alert('Usuario actualizado exitosamente');
            showUserManagement();
        }

        function deleteUser(userId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este usuario?')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex > -1) {
                    users.splice(userIndex, 1);
                    alert('Usuario eliminado exitosamente');
                    showUserManagement();
                }
            }
        }

        // Funci√≥n para mostrar historial de pr√©stamos de un usuario espec√≠fico (para bibliotecarios)
        function showUserLoanHistory(userId) {
            const user = users.find(u => u.id === userId);
            const userLoans = loans.filter(l => l.userId === userId);
            
            let content = `<h3>Historial de Pr√©stamos - ${user.name}</h3>`;
            
            if (userLoans.length === 0) {
                content += '<p>Este usuario no tiene historial de pr√©stamos.</p>';
            } else {
                content += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Fecha de Pr√©stamo</th>
                                <th>Fecha de Vencimiento</th>
                                <th>Fecha de Devoluci√≥n</th>
                                <th>Estado</th>
                                <th>D√≠as de Retraso</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userLoans.forEach(loan => {
                    const book = books.find(b => b.id === loan.bookId);
                    let daysLate = 0;
                    
                    if (loan.returnDate) {
                        const returnDate = new Date(loan.returnDate);
                        const dueDate = new Date(loan.dueDate);
                        if (returnDate > dueDate) {
                            daysLate = Math.ceil((returnDate - dueDate) / (1000 * 60 * 60 * 24));
                        }
                    } else if (loan.status === 'active' && new Date() > new Date(loan.dueDate)) {
                        daysLate = Math.ceil((new Date() - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
                    }
                    
                    content += `
                        <tr>
                            <td>${book.title}</td>
                            <td>${loan.loanDate}</td>
                            <td>${loan.dueDate}</td>
                            <td>${loan.returnDate || 'Pendiente'}</td>
                            <td>
                                <span class="status-badge ${loan.status === 'returned' ? 'status-available' : 'status-borrowed'}">
                                    ${loan.status === 'returned' ? 'Devuelto' : 'Activo'}
                                </span>
                            </td>
                            <td>${daysLate > 0 ? daysLate : '-'}</td>
                        </tr>
                    `;
                });

                content += '</tbody></table>';
            }

            showContent(`Historial - ${user.name}`, content);
        }

        // Funci√≥n para filtrar libros en el panel del bibliotecario
        function filterBooksLibrarian(query) {
            const table = document.getElementById('librarianBooksTable');
            if (!table) return;
            
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                if (text.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Funci√≥n para procesar el vencimiento autom√°tico de reservaciones y bloqueo de usuarios
        function processAutomaticActions() {
            const now = new Date();
            
            // Procesar reservaciones vencidas
            reservations.forEach(reservation => {
                if (reservation.status === 'active' && new Date(reservation.expirationDate) < now) {
                    reservation.status = 'expired';
                    
                    const book = books.find(b => b.id === reservation.bookId);
                    const copy = book.copies.find(c => c.id === reservation.copyId);
                    copy.status = 'available';
                    delete copy.reservedBy;
                    delete copy.reservationDate;
                    
                    const user = users.find(u => u.id === reservation.userId);
                    if (user) {
                        user.reservations--;
                    }
                }
            });

            // Procesar bloqueos autom√°ticos por pr√©stamos vencidos
            loans.forEach(loan => {
                if (loan.status === 'active' && new Date(loan.dueDate) < now) {
                    const user = users.find(u => u.id === loan.userId);
                    if (user && !user.blocked) {
                        user.blocked = true;
                        
                        // Generar multa autom√°tica para estudiantes
                        if (user.role === 'student') {
                            const daysLate = Math.ceil((now - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
                            const existingFine = fines.find(f => f.userId === user.id && f.loanId === loan.id);
                            
                            if (!existingFine) {
                                const book = books.find(b => b.id === loan.bookId);
                                const lateFine = {
                                    id: fines.length + 1,
                                    userId: user.id,
                                    loanId: loan.id,
                                    type: 'late',
                                    description: `Retraso de ${daysLate} d√≠as en la devoluci√≥n de "${book.title}"`,
                                    amount: daysLate * 500,
                                    date: now.toISOString().split('T')[0],
                                    status: 'pending'
                                };
                                fines.push(lateFine);
                            }
                        }
                    }
                }
            });
        }

        // Ejecutar acciones autom√°ticas cada minuto
        setInterval(processAutomaticActions, 60000);

        // Ejecutar una vez al cargar la p√°gina
        processAutomaticActions();
    </script>
</body>
</html>